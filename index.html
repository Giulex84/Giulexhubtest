<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>Giulex Hub – Pi SDK Baseline</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Pi SDK -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script>
      Pi.init({ version: "2.0" });
    </script>

    <style>
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #0b1020;
        color: #e5e7eb;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          system-ui, sans-serif;
      }

      .app {
        max-width: 420px;
        width: 100%;
        background: #0f172a;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(148, 163, 184, 0.2);
        text-align: center;
      }

      h1 {
        margin: 0 0 8px;
        font-size: 1.4rem;
      }

      .subtitle {
        font-size: 0.85rem;
        color: #9ca3af;
        margin-bottom: 20px;
      }

      button {
        width: 100%;
        border-radius: 999px;
        border: none;
        padding: 12px 16px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        background: #f97316;
        color: #111827;
        margin-bottom: 12px;
      }

      button:disabled {
        opacity: 0.5;
        cursor: default;
      }

      .status {
        margin-top: 12px;
        padding: 10px;
        font-size: 0.8rem;
        border-radius: 8px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(30, 64, 175, 0.6);
        white-space: pre-line;
      }

      .status.ok {
        border-color: #22c55e;
      }

      .tiny {
        margin-top: 16px;
        font-size: 0.7rem;
        color: #9ca3af;
      }

      a {
        color: #93c5fd;
        text-decoration: none;
      }
    </style>
  </head>

  <body>
    <main class="app">
      <h1>Giulex Hub</h1>
      <p class="subtitle">
        Pi SDK – Baseline Autenticazione (Checklist 10)
      </p>

      <button id="login">Login with Pi</button>

      <div id="status" class="status">
        Stato: in attesa di autenticazione…
      </div>

      <div class="tiny">
        <a href="privacy.html" target="_blank">Privacy Policy</a> ·
        <a href="terms.html" target="_blank">Terms of Service</a>
      </div>
    </main>

    <script>
      const statusEl = document.getElementById("status");
      const loginBtn = document.getElementById("login");

      let piUser = null;

      try {
        const saved = JSON.parse(localStorage.getItem("piUser"));
        if (saved && saved.uid) {
          piUser = saved;
        }
      } catch (_) {}

      if (piUser) {
        loginBtn.style.display = "none";
        statusEl.classList.add("ok");
        statusEl.textContent =
          "Autenticazione già presente ✅\nUser: " + piUser.username;
      }

      const scopes = ["username"];

      function onIncompletePayment(payment) {
        console.log("Incomplete payment found", payment);
      }

      loginBtn.onclick = async () => {
        loginBtn.disabled = true;
        statusEl.textContent = "Autenticazione Pi in corso…";

        try {
          const auth = await Pi.authenticate(scopes, onIncompletePayment);

          piUser = {
            uid: auth.user.uid,
            username: auth.user.username,
          };

          localStorage.setItem("piUser", JSON.stringify(piUser));

          loginBtn.style.display = "none";
          statusEl.classList.add("ok");
          statusEl.textContent =
            "Autenticazione completata ✅\nUser: " + piUser.username;
        } catch (err) {
          console.error("AUTH ERROR", err);
          loginBtn.disabled = false;
          statusEl.textContent =
            "Errore durante l’autenticazione.\nRiprova dal Pi Browser.";
        }
      };
    </script>
  </body>
</html>
